# 设计

分成三个组件：

- svm：在1024chain（基于solana的）上部署的solana智能合约
- relayer：中继服务器，监听evm的事件后向svm发送交易，对称的也监听svm的事件后向evm发送交易
- evm：在arbitrum sepolia上部署的evm智能合约

svm 和 evm 是对称的两端，两端分别可作为发送端和接收端：

只考虑 USDC 一种币的跨链转移，方式是在一端质押，在另一端金库中解锁等量代币。

## 发送端合约

需要实现如下接口：

### 初始化

初始化质押金库地址
初始化管理员钱包地址（和接收端钱包地址相同）

### 对端配置

配置对端接收端合约地址
自己的chain id 和对端的 chain id

### 质押

用户调用质押接口，传入质押数量和接收端地址
质押接口会将用户的币转入质押金库地址
质押接口会触发 **质押事件** ，事件中包含质押数量和接收，还有nonce防止重放

质押事件包括：
- 发送端合约地址（防止伪造事件）
- 接收端合约地址（防止伪造事件）
- chain_id
- block_height：交易发生时的区块高度（防止重放）
- 质押数量
- 接收地址
- nonce

nonce 是一个单调递增的数字，每次质押时加1

## 接收端合约

### 初始化

初始化质押金库地址（PS，和发送端金库地址相同。由于之后要自动完成转账，需要合约本身有转账的权力，具体在evm和svm中实现有所不同）
初始化管理员钱包地址

### 对端配置

配置对端发送端合约地址
初始化自己的chain id 和对端的 chain id

### relayer 白名单 增、删、查

管理relayer的公钥列表，用来鉴权和验证签名

### 接收 relayer 消息

只能白名单中的 relayer 调用
接收 relayer 消息，传入质押事件（包括质押数量、接收地址、nonce） 和 relayer 对hash的签名
验证源链合约地址正确
验证 chain id 正确
验证签名合法性
验证 nonce 未被使用
如果合法签名数量达到阈值（大于白名单大小的2/3以上），则执行解锁操作
解锁操作：从质押金库地址向接收地址转账等量代币
记录 nonce 为已使用，防止重放


## relayer

实际会部署大于3个独立的relayer，实现完全一样。

### 监听功能

必须能监听到发送端的质押事件

### 签名转发功能

验证消息正确性：
- 来自正确的发送端合约地址
- chain id 正确
- nonce 未被使用

正确后再将收到的信息hash之后，用自己的密钥签名。

然后调用 接收端合约的 接收 relayer 消息 接口，传入质押事件 和 自己的签名

## 配置项

便于后续在测试网、devnet、mainnet 之间切换，需要支持的配置项包括：

- 发送端链的RPC地址
- 接收端链的RPC地址
- 发送端合约地址
- 接收端合约地址
- 质押金库地址  （注意svm和evm的质押金库地址是不同的）
- 管理员钱包地址  （注意svm和evm的管理员钱包地址是不同的）
- relayer私钥列表  
- chain id：arb sepolia 和 arb mainnet ，1024chain testnet 和 mainnet 的 chain id，四个都是不同的，需要在部署合约时指定
