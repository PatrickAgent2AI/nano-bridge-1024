# 测试计划

## 用户故事

### US-001: 用户从 EVM 链转账到 SVM 链

**作为** 一个拥有 USDC 的 Arbitrum 用户  
**我想要** 将 USDC 转移到 1024chain  
**以便** 在 1024chain 上使用这些资金

**验收标准：**
1. 用户在 Arbitrum 上调用质押接口成功
2. 用户的 USDC 被正确转入质押金库
3. 质押事件被正确触发，包含所有必需字段
4. 至少 2/3 的 relayer 监听到事件并进行签名
5. 接收端合约验证签名并解锁等量 USDC
6. 用户在 1024chain 上收到等量的 USDC

### US-002: 用户从 SVM 链转账到 EVM 链

**作为** 一个拥有 USDC 的 1024chain 用户  
**我想要** 将 USDC 转移到 Arbitrum  
**以便** 在 Arbitrum 上使用这些资金

**验收标准：**
1. 用户在 1024chain 上调用质押接口成功
2. 用户的 USDC 被正确转入质押金库
3. 质押事件被正确触发，包含所有必需字段
4. 至少 2/3 的 relayer 监听到事件并进行签名
5. 接收端合约验证签名并解锁等量 USDC
6. 用户在 Arbitrum 上收到等量的 USDC

### US-003: 管理员管理 Relayer 白名单

**作为** 系统管理员  
**我想要** 能够添加、删除和查询 relayer  
**以便** 维护系统的安全性和可靠性

**验收标准：**
1. 管理员可以成功添加新的 relayer 地址
2. 管理员可以成功移除现有的 relayer 地址
3. 管理员可以查询指定地址是否为 relayer
4. 管理员可以查询当前 relayer 总数
5. 非管理员无法执行这些操作

### US-004: 防止重放攻击

**作为** 系统  
**我想要** 防止相同的质押事件被重复处理  
**以便** 保护用户资金安全

**验收标准：**
1. 每次质押生成唯一的 nonce
2. 接收端合约记录已使用的 nonce
3. 尝试使用相同 nonce 的请求被拒绝
4. 区块高度信息被正确记录和验证

---

## API 测试计划

### 发送端合约测试

#### TC-001: 初始化合约

**测试目标：** 验证发送端合约初始化功能

**前置条件：** 
- 合约未初始化
- 准备好金库地址和管理员地址

**测试步骤：**
1. 调用 `initialize(vaultAddress, adminAddress)` 方法
2. 验证初始化结果

**预期结果：**
- 合约初始化成功
- 金库地址、管理员地址被正确设置
- 初始 nonce 为 0

**测试数据：**
- vaultAddress: 有效的钱包地址
- adminAddress: 有效的钱包地址

#### TC-002: 配置对端

**测试目标：** 验证对端配置功能

**前置条件：**
- 合约已初始化
- 使用管理员账户调用

**测试步骤：**
1. 调用 `configureTarget(targetContract, sourceChainId, targetChainId)`
2. 验证配置结果

**预期结果：**
- 配置成功
- 对端合约地址、chain id 被正确设置

**测试数据：**
- targetContract: 接收端合约地址
- sourceChainId: 421614 (Arbitrum Sepolia)
- targetChainId: 1024chain testnet id

#### TC-003: 配置对端 - 非管理员权限

**测试目标：** 验证非管理员无法配置对端

**前置条件：**
- 使用非管理员账户调用

**测试步骤：**
1. 非管理员调用 `configureTarget()`

**预期结果：**
- 交易失败，返回权限错误
- 配置未生效

#### TC-004: 质押功能 - 成功场景

**测试目标：** 验证正常质押流程

**前置条件：**
- 合约已初始化并配置对端
- 用户拥有足够的 USDC 余额
- 用户已授权合约转账

**测试步骤：**
1. 用户调用 `stake(100, "target_address")`
2. 检查用户余额变化
3. 检查金库余额变化
4. 检查质押事件

**预期结果：**
- 用户 USDC 余额减少 100
- 金库 USDC 余额增加 100
- 触发 StakeEvent，包含正确的参数
- nonce 递增

**测试数据：**
- amount: 100 USDC
- receiverAddress: "0x1234...5678"

#### TC-005: 质押功能 - 余额不足

**测试目标：** 验证余额不足时的错误处理

**前置条件：**
- 用户 USDC 余额 < 质押数量

**测试步骤：**
1. 用户调用 `stake(1000, "target_address")`

**预期结果：**
- 交易失败，返回余额不足错误
- 用户余额不变
- 金库余额不变
- 不触发质押事件

#### TC-006: 质押功能 - 未授权

**测试目标：** 验证未授权时的错误处理

**前置条件：**
- 用户未授权合约转账

**测试步骤：**
1. 用户调用 `stake(100, "target_address")`

**预期结果：**
- 交易失败，返回授权不足错误
- 用户余额不变
- 金库余额不变

#### TC-007: 质押事件完整性

**测试目标：** 验证质押事件包含所有必需字段

**前置条件：**
- 成功执行质押操作

**测试步骤：**
1. 监听质押事件
2. 检查事件字段

**预期结果：**
- sourceContract: 发送端合约地址
- targetContract: 接收端合约地址
- chainId: 正确的 chain id
- blockHeight: 当前区块高度
- amount: 100
- receiverAddress: "target_address"
- nonce: 单调递增的值

---

### 接收端合约测试

#### TC-101: 初始化合约

**测试目标：** 验证接收端合约初始化功能

**前置条件：**
- 合约未初始化
- 准备好金库地址和管理员地址

**测试步骤：**
1. 调用 `initialize(vaultAddress, adminAddress)` 方法
2. 验证初始化结果

**预期结果：**
- 合约初始化成功
- 金库地址、管理员地址被正确设置
- relayer 白名单为空

#### TC-102: 配置对端

**测试目标：** 验证对端配置功能

**前置条件：**
- 合约已初始化
- 使用管理员账户调用

**测试步骤：**
1. 调用 `configureSource(sourceContract, sourceChainId, targetChainId)`
2. 验证配置结果

**预期结果：**
- 配置成功
- 对端合约地址、chain id 被正确设置

**测试数据：**
- sourceContract: 发送端合约地址
- sourceChainId: 1024chain testnet id
- targetChainId: 421614 (Arbitrum Sepolia)

#### TC-103: 配置对端 - 非管理员权限

**测试目标：** 验证非管理员无法配置对端

**前置条件：**
- 使用非管理员账户调用

**测试步骤：**
1. 非管理员调用 `configureSource()`

**预期结果：**
- 交易失败，返回权限错误
- 配置未生效

#### TC-104: 添加 Relayer - 管理员权限

**测试目标：** 验证管理员可以添加 relayer

**前置条件：**
- 合约已初始化
- 使用管理员账户调用

**测试步骤：**
1. 调用 `addRelayer(relayerAddress1)`
2. 调用 `addRelayer(relayerAddress2)`
3. 调用 `addRelayer(relayerAddress3)`
4. 查询 relayer 数量

**预期结果：**
- 三个 relayer 添加成功
- `getRelayerCount()` 返回 3
- `isRelayer(relayerAddress1)` 返回 true

#### TC-105: 添加 Relayer - 非管理员权限

**测试目标：** 验证非管理员无法添加 relayer

**前置条件：**
- 合约已初始化
- 使用非管理员账户调用

**测试步骤：**
1. 调用 `addRelayer(relayerAddress)`

**预期结果：**
- 交易失败，返回权限错误
- relayer 未被添加

#### TC-106: 移除 Relayer - 管理员权限

**测试目标：** 验证管理员可以移除 relayer

**前置条件：**
- 白名单中已有 relayer

**测试步骤：**
1. 调用 `removeRelayer(relayerAddress1)`
2. 查询 relayer 状态

**预期结果：**
- relayer 移除成功
- `isRelayer(relayerAddress1)` 返回 false
- `getRelayerCount()` 减少 1

#### TC-107: 提交签名 - 单个 Relayer

**测试目标：** 验证单个 relayer 提交签名

**前置条件：**
- 白名单中有 3 个 relayer
- 有有效的质押事件数据

**测试步骤：**
1. relayer1 调用 `submitSignature(eventData, signature1)`
2. 检查合约状态

**预期结果：**
- 签名提交成功
- 签名被记录
- 未达到阈值，不执行解锁
- nonce 未被标记为已使用

#### TC-108: 提交签名 - 达到阈值

**测试目标：** 验证达到 2/3 阈值后执行解锁

**前置条件：**
- 白名单中有 3 个 relayer
- 金库有足够余额

**测试步骤：**
1. relayer1 提交签名
2. relayer2 提交签名
3. 检查接收地址余额
4. 检查 nonce 状态

**预期结果：**
- 2 个签名达到阈值（2/3 * 3 = 2）
- 接收地址收到等量 USDC
- 金库余额减少相应数量
- nonce 被标记为已使用

#### TC-109: 提交签名 - 重复 Nonce

**测试目标：** 验证防重放机制

**前置条件：**
- 某个 nonce 已被使用

**测试步骤：**
1. 使用相同 nonce 的事件数据提交签名

**预期结果：**
- 交易失败，返回 nonce 已使用错误
- 不执行解锁操作

#### TC-110: 提交签名 - 无效签名

**测试目标：** 验证签名验证机制

**前置条件：**
- 有效的事件数据
- 错误的签名（非 relayer 私钥签名）

**测试步骤：**
1. 提交错误签名

**预期结果：**
- 交易失败，返回签名无效错误
- 签名未被记录

#### TC-111: 提交签名 - 非白名单 Relayer

**测试目标：** 验证白名单验证机制

**前置条件：**
- 调用者不在白名单中

**测试步骤：**
1. 非白名单地址调用 `submitSignature()`

**预期结果：**
- 交易失败，返回权限错误
- 签名未被记录

#### TC-112: 提交签名 - 错误的源链合约地址

**测试目标：** 验证接收端合约验证源链合约地址

**前置条件：**
- 接收端合约已配置正确的源链合约地址
- Relayer 在白名单中

**测试步骤：**
1. 构造包含错误源链合约地址的事件数据
2. Relayer 提交签名

**预期结果：**
- 接收端合约检测到合约地址不匹配
- 交易失败或被拒绝
- 记录安全日志

#### TC-113: 提交签名 - 错误的 Chain ID

**测试目标：** 验证接收端合约验证 chain id

**前置条件：**
- 接收端合约已配置正确的 chain id
- Relayer 在白名单中

**测试步骤：**
1. 构造包含错误 chain id 的事件数据
2. Relayer 提交签名

**预期结果：**
- 接收端合约检测到 chain id 不匹配
- 交易失败或被拒绝
- 记录安全日志

---

### Relayer 服务测试

#### TC-201: 监听质押事件

**测试目标：** 验证 relayer 能正确监听事件

**前置条件：**
- Relayer 服务运行中
- 连接到发送端链 RPC

**测试步骤：**
1. 在发送端链执行质押操作
2. 观察 relayer 日志

**预期结果：**
- Relayer 成功捕获 StakeEvent
- 事件数据完整且正确
- 日志记录事件详情

#### TC-202: 签名生成

**测试目标：** 验证 relayer 正确生成签名

**前置条件：**
- 接收到质押事件

**测试步骤：**
1. Relayer 处理事件数据
2. 生成签名
3. 验证签名格式

**预期结果：**
- 签名格式正确（ECDSA）
- 签名可以恢复出 relayer 地址
- Hash 计算正确

#### TC-203: 提交签名到接收端

**测试目标：** 验证 relayer 正确提交签名

**前置条件：**
- 已生成有效签名
- 接收端合约可访问

**测试步骤：**
1. Relayer 调用接收端合约
2. 提交事件数据和签名

**预期结果：**
- 交易成功提交
- 接收端合约接受签名
- 返回成功状态

#### TC-204: 多 Relayer 协同

**测试目标：** 验证多个 relayer 协同工作

**前置条件：**
- 3 个 relayer 服务运行中
- 都在白名单中

**测试步骤：**
1. 执行质押操作
2. 观察 3 个 relayer 的行为
3. 检查接收端结果

**预期结果：**
- 所有 relayer 都监听到事件
- 所有 relayer 都提交签名
- 前 2 个签名达到阈值后执行解锁
- 第 3 个签名仍然被接受但不再触发解锁

#### TC-205: Relayer 故障恢复

**测试目标：** 验证 relayer 故障情况下系统仍可工作

**前置条件：**
- 3 个 relayer，1 个故障

**测试步骤：**
1. 停止 1 个 relayer
2. 执行质押操作
3. 观察剩余 2 个 relayer

**预期结果：**
- 2 个 relayer 正常工作
- 仍能达到 2/3 阈值
- 解锁操作正常执行

#### TC-206: Relayer 消息验证 - 错误的合约地址

**测试目标：** 验证 relayer 拒绝来自错误合约的事件

**前置条件：**
- Relayer 配置了正确的发送端合约地址

**测试步骤：**
1. 模拟一个来自错误合约地址的质押事件
2. 观察 relayer 行为

**预期结果：**
- Relayer 检测到合约地址不匹配
- Relayer 拒绝处理该事件
- 不向接收端合约提交签名
- 记录警告日志

#### TC-207: Relayer 消息验证 - 错误的 Chain ID

**测试目标：** 验证 relayer 拒绝错误 chain id 的事件

**前置条件：**
- Relayer 配置了正确的 chain id

**测试步骤：**
1. 模拟一个包含错误 chain id 的质押事件
2. 观察 relayer 行为

**预期结果：**
- Relayer 检测到 chain id 不匹配
- Relayer 拒绝处理该事件
- 不向接收端合约提交签名
- 记录警告日志

#### TC-208: Relayer 消息验证 - 重复的 Nonce

**测试目标：** 验证 relayer 检测重复 nonce

**前置条件：**
- Relayer 已处理过某个 nonce 的事件

**测试步骤：**
1. 尝试用相同 nonce 再次触发事件
2. 观察 relayer 行为

**预期结果：**
- Relayer 检测到 nonce 已被处理
- Relayer 跳过该事件（或仍然提交，由接收端拒绝）
- 记录信息日志

---

## 集成测试

### IT-001: 端到端跨链转账（EVM → SVM）

**测试目标：** 验证完整的跨链转账流程

**测试步骤：**
1. 准备测试环境（EVM 和 SVM 合约已部署）
2. 用户在 Arbitrum 执行质押 100 USDC
3. 等待 relayer 处理
4. 验证 1024chain 上接收地址余额

**预期结果：**
- 整个流程在合理时间内完成（< 5 分钟）
- 接收地址收到 100 USDC
- 所有事件和交易记录正确

### IT-002: 端到端跨链转账（SVM → EVM）

**测试目标：** 验证反向跨链转账流程

**测试步骤：**
1. 用户在 1024chain 执行质押 100 USDC
2. 等待 relayer 处理
3. 验证 Arbitrum 上接收地址余额

**预期结果：**
- 整个流程正常完成
- 接收地址收到 100 USDC

### IT-003: 并发跨链转账

**测试目标：** 验证系统处理并发请求的能力

**测试步骤：**
1. 10 个用户同时发起质押请求
2. 观察系统行为
3. 验证所有转账结果

**预期结果：**
- 所有请求都被正确处理
- 每个请求的 nonce 唯一
- 所有接收地址都收到正确金额

### IT-004: 大额转账测试

**测试目标：** 验证系统处理大额转账的能力

**测试步骤：**
1. 执行 10,000 USDC 的质押
2. 验证结果

**预期结果：**
- 转账成功完成
- 金额精确匹配

---

## 安全测试

### ST-001: 重放攻击防御

**测试目标：** 验证系统防御重放攻击

**测试步骤：**
1. 捕获一次成功的质押事件
2. 尝试重放相同的事件数据和签名
3. 尝试修改 nonce 后重放

**预期结果：**
- 相同 nonce 的重放被拒绝
- 修改后的签名验证失败

### ST-002: 签名伪造防御

**测试目标：** 验证系统防御签名伪造

**测试步骤：**
1. 使用非 relayer 私钥生成签名
2. 提交到接收端合约

**预期结果：**
- 签名验证失败
- 交易被拒绝

### ST-003: 权限控制测试

**测试目标：** 验证管理员权限控制

**测试步骤：**
1. 非管理员尝试添加 relayer
2. 非管理员尝试移除 relayer

**预期结果：**
- 所有操作都被拒绝
- 返回权限错误

### ST-004: 金库安全测试

**测试目标：** 验证金库资金安全

**测试步骤：**
1. 尝试直接从金库转账（绕过合约）
2. 尝试超额解锁

**预期结果：**
- 直接转账失败（权限控制）
- 超额解锁失败（余额检查）

### ST-005: 伪造事件防御

**测试目标：** 验证系统防御伪造事件攻击

**测试步骤：**
1. 构造一个伪造的质押事件，使用错误的合约地址
2. 构造一个伪造的质押事件，使用错误的 chain id
3. 观察 relayer 和接收端合约的行为

**预期结果：**
- Relayer 在验证阶段拒绝处理伪造事件
- 即使 relayer 绕过验证，接收端合约也会通过验证合约地址和 chain id 拒绝
- 系统记录安全日志

---

## 性能测试

### PT-001: 事件监听延迟

**测试目标：** 测量事件监听的延迟

**测试步骤：**
1. 记录质押交易确认时间
2. 记录 relayer 接收事件时间
3. 计算延迟

**性能指标：**
- 目标：< 30 秒

### PT-002: 签名提交延迟

**测试目标：** 测量从接收事件到提交签名的时间

**测试步骤：**
1. 记录 relayer 接收事件时间
2. 记录签名提交交易确认时间
3. 计算延迟

**性能指标：**
- 目标：< 1 分钟

### PT-003: 端到端延迟

**测试目标：** 测量完整跨链转账时间

**测试步骤：**
1. 记录质押交易时间
2. 记录解锁完成时间
3. 计算总延迟

**性能指标：**
- 目标：< 5 分钟
- 可接受：< 10 分钟

### PT-004: 吞吐量测试

**测试目标：** 测试系统每小时可处理的跨链转账数量

**测试步骤：**
1. 持续 1 小时发送质押请求
2. 统计成功处理的数量

**性能指标：**
- 目标：> 100 笔/小时
