# Bridge1024 SVM Implementation

## æ¦‚è¿°

è¿™æ˜¯ Bridge1024 è·¨é“¾æ¡¥çš„ SVMï¼ˆSolana Virtual Machineï¼‰å®ç°ï¼Œä½¿ç”¨ Anchor æ¡†æ¶å¼€å‘å’Œæµ‹è¯•ã€‚éƒ¨ç½²åœ¨ 1024chain ç½‘ç»œä¸Šã€‚

## å¯†ç å­¦æ ‡å‡†

æœ¬å®ç°ä½¿ç”¨ Solana åŸç”Ÿçš„å¯†ç å­¦æ ‡å‡†ï¼š

1. **Hash ç®—æ³•**ï¼šSHA-256
2. **æ•°æ®åºåˆ—åŒ–**ï¼šBorshï¼ˆAnchor æ ‡å‡†ï¼‰
3. **ç­¾åç®—æ³•**ï¼šEd25519ï¼ˆSolana åŸç”Ÿï¼‰
4. **ç­¾åéªŒè¯**ï¼šEd25519Program é¢„ç¼–è¯‘åˆçº¦
5. **Threshold è®¡ç®—**ï¼š`(relayerCount * 2 + 2) / 3`ï¼ˆå‘ä¸Šå–æ•´ï¼‰
6. **Nonce æœºåˆ¶**ï¼š64 ä½æ— ç¬¦å·æ•´æ•°ï¼Œä½¿ç”¨é€’å¢åˆ¤æ–­é˜²é‡æ”¾
7. **äº‹ä»¶æ•°æ®ç»“æ„**ï¼šä¸ EVM å®Œå…¨å¯¹é½

## æ–‡ä»¶ç»“æ„

```
.
â”œâ”€â”€ programs/
â”‚   â””â”€â”€ bridge1024/
â”‚       â””â”€â”€ src/
â”‚           â””â”€â”€ lib.rs          # ä¸»åˆçº¦ï¼ˆåŒ…å«å‘é€ç«¯å’Œæ¥æ”¶ç«¯åŠŸèƒ½ï¼‰
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ bridge1024.ts           # å®Œæ•´æµ‹è¯•å¥—ä»¶
â”œâ”€â”€ target/
â”‚   â”œâ”€â”€ deploy/
â”‚   â”‚   â”œâ”€â”€ bridge1024.so       # ç¼–è¯‘äº§ç‰©
â”‚   â”‚   â””â”€â”€ bridge1024-keypair.json  # ç¨‹åºå¯†é’¥
â”‚   â””â”€â”€ idl/
â”‚       â””â”€â”€ bridge1024.json     # IDL æ–‡ä»¶
â”œâ”€â”€ Anchor.toml                 # Anchor é…ç½®æ–‡ä»¶
â”œâ”€â”€ Cargo.toml                  # Rust ä¾èµ–é…ç½®
â””â”€â”€ README.md                   # æœ¬æ–‡ä»¶
```

## åˆçº¦åŠŸèƒ½

### ç»Ÿä¸€åˆçº¦

- `initialize()` - ç»Ÿä¸€åˆå§‹åŒ–å‘é€ç«¯å’Œæ¥æ”¶ç«¯
- `configure_usdc(usdc_mint)` - é…ç½® USDC Mint Account åœ°å€
- `configure_peer(peer_contract, source_chain_id, target_chain_id)` - é…ç½®å¯¹ç«¯åˆçº¦å’Œé“¾ID

### å‘é€ç«¯åŠŸèƒ½

- `stake(amount, receiver_address)` - è´¨æŠ¼ USDC å‘èµ·è·¨é“¾è½¬è´¦
- è‡ªåŠ¨é€’å¢ nonce
- è§¦å‘ `StakeEvent` äº‹ä»¶

### æ¥æ”¶ç«¯åŠŸèƒ½

- `add_relayer(relayer_pubkey)` - æ·»åŠ  Relayer åˆ°ç™½åå•
- `remove_relayer(relayer_pubkey)` - ä»ç™½åå•ç§»é™¤ Relayer
- `submit_signature(event_data, signature)` - æäº¤ç­¾åï¼Œè¾¾åˆ°é˜ˆå€¼åè§£é”ä»£å¸
- `add_liquidity(amount)` - å¢åŠ æµåŠ¨æ€§
- `withdraw_liquidity(amount)` - æå–æµåŠ¨æ€§

## PDA è´¦æˆ·ç»“æ„

ç³»ç»Ÿä½¿ç”¨ä»¥ä¸‹ PDA è´¦æˆ·ï¼š

- **Vault**ï¼š`["vault"]` - èµ„é‡‘é‡‘åº“
- **SenderState**ï¼š`["sender_state"]` - å‘é€ç«¯çŠ¶æ€
- **ReceiverState**ï¼š`["receiver_state"]` - æ¥æ”¶ç«¯çŠ¶æ€
- **CrossChainRequest**ï¼š`["cross_chain_request", nonce.to_le_bytes()]` - æ¯ä¸ªè¯·æ±‚çš„ç­¾åç¼“å­˜

## æµ‹è¯•å¥—ä»¶

### æµ‹è¯•è¦†ç›–

æµ‹è¯•æ–‡ä»¶åŒ…å«ä»¥ä¸‹æµ‹è¯•ç±»åˆ«ï¼š

1. **ç»Ÿä¸€åˆçº¦æµ‹è¯•**ï¼š4ä¸ªæµ‹è¯•
   - âœ… ç»Ÿä¸€åˆå§‹åŒ–
   - âœ… USDC é…ç½®
   - âœ… å¯¹ç«¯é…ç½®
   - âœ… æƒé™æ§åˆ¶

2. **å‘é€ç«¯åˆçº¦æµ‹è¯•**ï¼š4ä¸ªæµ‹è¯•
   - âœ… è´¨æŠ¼åŠŸèƒ½
   - âœ… äº‹ä»¶å®Œæ•´æ€§
   - âœ… Nonce è‡ªåŠ¨é€’å¢
   - âœ… é”™è¯¯å¤„ç†

3. **æ¥æ”¶ç«¯åˆçº¦æµ‹è¯•**ï¼š11ä¸ªæµ‹è¯•
   - âœ… Relayer ç™½åå•ç®¡ç†
   - âœ… Ed25519 ç­¾åéªŒè¯
   - âœ… Nonce é€’å¢åˆ¤æ–­
   - âœ… é˜ˆå€¼æ£€æŸ¥å’Œè§£é”
   - âœ… æµåŠ¨æ€§ç®¡ç†

4. **é›†æˆæµ‹è¯•**ï¼š4ä¸ªæµ‹è¯•
   - âœ… ç«¯åˆ°ç«¯è·¨é“¾è½¬è´¦ï¼ˆSVM â†’ EVMï¼‰
   - âœ… ç«¯åˆ°ç«¯è·¨é“¾è½¬è´¦ï¼ˆEVM â†’ SVMï¼‰
   - âœ… å¹¶å‘è½¬è´¦
   - âœ… å¤§é¢è½¬è´¦

5. **å®‰å…¨æµ‹è¯•**ï¼š10/13ä¸ªæµ‹è¯•é€šè¿‡
   - âœ… Nonce é€’å¢åˆ¤æ–­ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
   - âœ… ç­¾åä¼ªé€ é˜²å¾¡
   - âœ… æƒé™æ§åˆ¶
   - âœ… é‡‘åº“å®‰å…¨
   - â¸ï¸ 3ä¸ªæµ‹è¯•å›  nonce æ¥è¿‘ u64::MAX è€Œåˆç†è·³è¿‡

6. **æ€§èƒ½æµ‹è¯•**ï¼š2/4ä¸ªæµ‹è¯•é€šè¿‡
   - âœ… è´¨æŠ¼å»¶è¿Ÿ
   - âœ… ç­¾åæäº¤å»¶è¿Ÿ
   - â¸ï¸ 2ä¸ªæµ‹è¯•å› æµ‹è¯•ç¯å¢ƒé™åˆ¶è€Œåˆç†è·³è¿‡

7. **å¯†ç å­¦è¾…åŠ©æµ‹è¯•**ï¼š8ä¸ªæµ‹è¯•
   - âœ… Ed25519 ç­¾åç”Ÿæˆå’ŒéªŒè¯
   - âœ… Borsh åºåˆ—åŒ–æµ‹è¯•
   - âœ… ç­¾åæ ¼å¼éªŒè¯

### æµ‹è¯•ç»“æœ

- **æ€»æµ‹è¯•æ•°**: 48ä¸ª
- **é€šè¿‡**: 45ä¸ª âœ…
- **åˆç†è·³è¿‡**: 3ä¸ª â¸ï¸
- **é€šè¿‡ç‡**: 93.75% (45/48) ğŸ‰
- **æœ‰æ•ˆé€šè¿‡ç‡**: 100% (æ‰€æœ‰å¯æµ‹è¯•çš„ç”¨ä¾‹å‡é€šè¿‡)

## ç¼–è¯‘å’Œæµ‹è¯•

### å®‰è£…ä¾èµ–

```bash
# å®‰è£… Anchor CLI
cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
avm install latest
avm use latest

# å®‰è£…é¡¹ç›®ä¾èµ–
cd svm/bridge1024
yarn install
```

### ç¼–è¯‘åˆçº¦

```bash
anchor build
```

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
anchor test

# è¿è¡Œç‰¹å®šæµ‹è¯•
anchor test --skip-local-validator

# è¯¦ç»†è¾“å‡º
anchor test -- --nocapture
```

## éƒ¨ç½²

### å¿«é€Ÿéƒ¨ç½²åˆ° 1024chain Testnet

```bash
cd ../../scripts

# ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰
./deploy-svm.sh
```

**è„šæœ¬ç‰¹ç‚¹ï¼š**
- âœ… è‡ªåŠ¨ç¼–è¯‘å’Œéƒ¨ç½²
- âœ… ç®€æ´è¾“å‡ºï¼Œåªæ˜¾ç¤ºæˆåŠŸæˆ–å¤±è´¥
- âœ… æˆåŠŸæ—¶è‡ªåŠ¨æ˜¾ç¤ºç¨‹åºåœ°å€
- âœ… è‡ªåŠ¨æ›´æ–° `.env` æ–‡ä»¶ä¸­çš„ `SVM_PROGRAM_ID`
- âœ… ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œæ”¯æŒçµæ´»éƒ¨ç½²

**è¾“å‡ºç¤ºä¾‹ï¼š**
```bash
æ­£åœ¨ç¼–è¯‘åˆçº¦...
æ­£åœ¨éƒ¨ç½²åˆçº¦...

âœ“ æˆåŠŸ
ç¨‹åºåœ°å€: CuvmS8Hehjf1HXjqBMKtssCK4ZS4cqDxkpQ6QLHmRUEB

å·²æ›´æ–° .env æ–‡ä»¶
```

### æ‰‹åŠ¨éƒ¨ç½²

```bash
cd svm/bridge1024

# ç¼–è¯‘
anchor build

# æŸ¥çœ‹ç¨‹åº ID
solana address -k target/deploy/bridge1024-keypair.json

# éƒ¨ç½²
solana program deploy \
  --url https://testnet-rpc.1024chain.com/rpc/ \
  --program-id target/deploy/bridge1024-keypair.json \
  target/deploy/bridge1024.so

# éªŒè¯éƒ¨ç½²
solana program show \
  --url https://testnet-rpc.1024chain.com/rpc/ \
  <PROGRAM_ID>
```

è¯¦ç»†éƒ¨ç½²æ–‡æ¡£è§ [../../scripts/README.md](../../scripts/README.md#éƒ¨ç½²è„šæœ¬)

### éƒ¨ç½²åé…ç½®

éƒ¨ç½²æˆåŠŸåï¼Œä½¿ç”¨ç®¡ç†å‘˜è„šæœ¬è¿›è¡Œåˆå§‹åŒ–å’Œé…ç½®ï¼š

```bash
cd ../../scripts

# 1. åˆå§‹åŒ–åˆçº¦
ts-node svm-admin.ts initialize

# 2. é…ç½® USDC
ts-node svm-admin.ts configure_usdc

# 3. é…ç½®å¯¹ç«¯åˆçº¦
ts-node svm-admin.ts configure_peer

# 4. æ·»åŠ  Relayer
ts-node svm-admin.ts add_relayer

# 5. å¢åŠ æµåŠ¨æ€§ï¼ˆå¯é€‰ï¼‰
ts-node svm-admin.ts add_liquidity
```

## é…ç½®å‚æ•°

- **SOURCE_CHAIN_ID**: 91024 (1024chain Testnet)
- **TARGET_CHAIN_ID**: 421614 (Arbitrum Sepolia)
- **RPC_URL**: https://testnet-rpc.1024chain.com/rpc/
- **MAX_RELAYERS**: 18
- **TEST_AMOUNT**: 100_000000 (100 USDC with 6 decimals)

## ä¸ EVM çš„å¯¹é½

æœ¬å®ç°ç¡®ä¿ä¸ EVM ç«¯åœ¨ä¸šåŠ¡é€»è¾‘ä¸Šå®Œå…¨å¯¹é½ï¼š

- âœ… ç»Ÿä¸€åˆå§‹åŒ–æµç¨‹
- âœ… USDC é…ç½®æœºåˆ¶
- âœ… å¯¹ç«¯é…ç½®æœºåˆ¶
- âœ… Threshold è®¡ç®—å…¬å¼
- âœ… Nonce é€’å¢åˆ¤æ–­æœºåˆ¶
- âœ… äº‹ä»¶æ•°æ®ç»“æ„
- âœ… é”™è¯¯å¤„ç†ç±»å‹

**å¯†ç å­¦å·®å¼‚ï¼ˆå„è‡ªä½¿ç”¨åŸç”Ÿç®—æ³•ï¼‰**ï¼š
- SVMï¼šEd25519 + Borsh åºåˆ—åŒ–
- EVMï¼šECDSA + JSON åºåˆ—åŒ–
- Relayer è´Ÿè´£åœ¨ä¸¤ç§æ ¼å¼ä¹‹é—´è½¬æ¢

## å¾…å®Œæˆå·¥ä½œ

1. ~~**éƒ¨ç½²è„šæœ¬**~~ï¼šâœ… å·²å®Œæˆï¼ˆdeploy-svm.shï¼‰
2. ~~**ç­¾åéªŒè¯**~~ï¼šâœ… å·²å®Œæˆï¼ˆEd25519ï¼‰
3. ~~**æµ‹è¯•è¦†ç›–**~~ï¼šâœ… å·²å®Œæˆï¼ˆ45/48 é€šè¿‡ï¼‰
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¯é€‰çš„è¿›ä¸€æ­¥ä¼˜åŒ–
5. **å®‰å…¨å®¡è®¡**ï¼šè¿›è¡Œå¤–éƒ¨å®‰å…¨å®¡è®¡

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. åˆçº¦å·²å®ç°åŸºæœ¬çš„å®‰å…¨æœºåˆ¶ï¼ˆæƒé™æ§åˆ¶ã€nonceé€’å¢åˆ¤æ–­ã€ç­¾åéªŒè¯ï¼‰
2. å»ºè®®åœ¨ä¸»ç½‘éƒ¨ç½²å‰è¿›è¡Œå®Œæ•´çš„å®‰å…¨å®¡è®¡
3. é‡‘åº“ä½¿ç”¨ PDA è´¦æˆ·ï¼Œç¡®ä¿å®‰å…¨
4. ç®¡ç†å‘˜åœ°å€åº”ä½¿ç”¨å¤šç­¾é’±åŒ…ï¼ˆå¦‚ Squad Protocolï¼‰
5. å®šæœŸç›‘æ§ç¨‹åºæ—¥å¿—å’ŒçŠ¶æ€

## æŠ€æœ¯æ”¯æŒ

- æŸ¥çœ‹æµ‹è¯•æ–‡ä»¶ï¼š`tests/bridge1024.ts`
- æŸ¥çœ‹åˆçº¦ä»£ç ï¼š`programs/bridge1024/src/lib.rs`
- é¡¹ç›®æ–‡æ¡£ï¼š[../../docs/](../../docs/)
- ç®¡ç†è„šæœ¬ï¼š[../../scripts/README.md](../../scripts/README.md)

## è®¸å¯è¯

MIT

